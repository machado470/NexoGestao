generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  COLLABORATOR
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CorrectiveStatus {
  OPEN
  AWAITING_REASSESSMENT
  DONE
}

enum TimelineSeverity {
  INFO
  WARNING
  CRITICAL
  SUCCESS
}

enum ExceptionType {
  VACATION
  LEAVE
  PAUSE
}

enum TrackStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum TrackItemType {
  READING
  ACTION
  CHECKPOINT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELED
  DONE
  NO_SHOW
}

enum ServiceOrderStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  DONE
  CANCELED
}

enum ChargeStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

enum PaymentMethod {
  PIX
  CASH
  CARD
  TRANSFER
  OTHER
}

model Organization {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  requiresOnboarding Boolean  @default(true)
  createdAt          DateTime @default(now())

  users          User[]
  persons        Person[]
  tracks         Track[]
  runs           GovernanceRun[]
  timelineEvents TimelineEvent[]
  auditEvents    AuditEvent[]

  customers     Customer[]
  appointments  Appointment[]
  serviceOrders ServiceOrder[]
  charges       Charge[]
  payments      Payment[]
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String?
  role     UserRole

  active          Boolean   @default(false)
  inviteToken     String?   @unique
  inviteExpiresAt DateTime?

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  person Person?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Person {
  id     String  @id @default(uuid())
  name   String
  email  String?
  role   String
  active Boolean @default(true)

  riskScore      Int       @default(0)
  offboardedAt   DateTime?
  offboardReason String?

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  assignments       Assignment[]
  assessments       Assessment[]
  correctiveActions CorrectiveAction[]
  auditEvents       AuditEvent[]
  timelineEvents    TimelineEvent[]
  riskSnapshots     RiskSnapshot[]
  exceptions        PersonException[]
  itemCompletions   TrackItemCompletion[]

  serviceOrdersAssigned ServiceOrder[] @relation("ServiceOrderAssignedTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, createdAt])
  @@index([orgId, active, createdAt])
}

model TimelineEvent {
  id          String  @id @default(uuid())
  action      String
  personId    String?
  description String?
  metadata    Json?

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())

  person Person? @relation(fields: [personId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, action, createdAt])
  @@index([personId, createdAt])
  @@index([action, createdAt])
}

model Track {
  id          String      @id @default(uuid())
  title       String
  description String?
  slug        String
  version     Int         @default(1)
  status      TrackStatus @default(DRAFT)

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())

  assignments Assignment[]
  assessments Assessment[]
  items       TrackItem[]

  @@unique([slug, version, orgId])
  @@index([orgId])
  @@index([orgId, status, createdAt])
}

model TrackItem {
  id      String        @id @default(uuid())
  trackId String
  title   String
  content String?
  type    TrackItemType
  order   Int

  createdAt DateTime @default(now())

  track       Track                 @relation(fields: [trackId], references: [id])
  completions TrackItemCompletion[]

  @@unique([trackId, order])
  @@index([trackId, order])
}

model TrackItemCompletion {
  id           String @id @default(uuid())
  itemId       String
  personId     String
  assignmentId String

  completedAt DateTime @default(now())

  item       TrackItem  @relation(fields: [itemId], references: [id])
  person     Person     @relation(fields: [personId], references: [id])
  assignment Assignment @relation(fields: [assignmentId], references: [id])

  @@unique([itemId, personId])
  @@index([personId, completedAt])
  @@index([assignmentId, completedAt])
}

model Assignment {
  id       String @id @default(uuid())
  personId String
  trackId  String

  progress Int       @default(0)
  risk     RiskLevel @default(LOW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  person Person @relation(fields: [personId], references: [id])
  track  Track  @relation(fields: [trackId], references: [id])

  assessments Assessment[]
  completions TrackItemCompletion[]

  @@unique([personId, trackId])
  @@index([personId, createdAt])
  @@index([trackId, createdAt])
}

model Assessment {
  id           String @id @default(uuid())
  assignmentId String
  personId     String
  trackId      String

  score Int
  risk  RiskLevel
  notes String?

  createdAt DateTime @default(now())

  assignment Assignment @relation(fields: [assignmentId], references: [id])
  person     Person     @relation(fields: [personId], references: [id])
  track      Track      @relation(fields: [trackId], references: [id])

  @@index([personId, createdAt])
  @@index([trackId, createdAt])
  @@index([assignmentId, createdAt])
}

model CorrectiveAction {
  id         String           @id @default(uuid())
  personId   String
  reason     String
  status     CorrectiveStatus @default(OPEN)
  resolvedAt DateTime?

  createdAt DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, status, createdAt])
  @@index([status, createdAt])
}

model PersonException {
  id       String        @id @default(uuid())
  personId String
  type     ExceptionType
  reason   String
  startsAt DateTime
  endsAt   DateTime

  processedAt DateTime?

  createdAt DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, startsAt, endsAt])
  @@index([endsAt, processedAt])
}

model AuditEvent {
  id String @id @default(uuid())

  // ⚠️ legado (compat). Continua existindo.
  personId String?

  // ✅ institucional (multi-tenant + autoria + entidade)
  orgId         String
  actorUserId   String?
  actorPersonId String?
  entityType    String?
  entityId      String?

  action   String
  context  String?
  metadata Json?

  createdAt DateTime @default(now())

  person Person?      @relation(fields: [personId], references: [id])
  org    Organization @relation(fields: [orgId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, action, createdAt])
  @@index([personId, createdAt])
  @@index([action, createdAt])
}

model RiskSnapshot {
  id       String @id @default(uuid())
  personId String
  score    Int
  reason   String

  createdAt DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, createdAt])
}

model GovernanceRun {
  id String @id @default(uuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  evaluated   Int @default(0)
  warnings    Int @default(0)
  correctives Int @default(0)

  institutionalRiskScore Int @default(0)
  restrictedCount        Int @default(0)
  suspendedCount         Int @default(0)
  openCorrectivesCount   Int @default(0)

  durationMs Int @default(0)

  startedAt  DateTime
  finishedAt DateTime
  createdAt  DateTime @default(now())

  @@index([orgId, createdAt])
}

model Customer {
  id    String       @id @default(uuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  name   String
  phone  String
  email  String?
  notes  String?
  active Boolean @default(true)

  appointments  Appointment[]
  serviceOrders ServiceOrder[]
  charges       Charge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, createdAt])
  @@index([orgId, active, createdAt])
  @@index([orgId, email])
}

model Appointment {
  id    String       @id @default(uuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  startsAt DateTime
  endsAt   DateTime
  status   AppointmentStatus @default(SCHEDULED)
  notes    String?

  serviceOrder ServiceOrder?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, startsAt])
  @@index([orgId, startsAt, endsAt])
  @@index([orgId, status, startsAt])
  @@index([customerId, startsAt])
}

model ServiceOrder {
  id String @id @default(uuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  assignedToPersonId String?
  assignedToPerson   Person? @relation("ServiceOrderAssignedTo", fields: [assignedToPersonId], references: [id])

  title       String
  description String?
  status      ServiceOrderStatus @default(OPEN)
  priority    Int                @default(2)

  scheduledFor DateTime?
  startedAt    DateTime?
  finishedAt   DateTime?

  charges Charge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, createdAt])
  @@index([orgId, status, createdAt])
  @@index([orgId, customerId, createdAt])
  @@index([orgId, scheduledFor])
  @@index([assignedToPersonId, createdAt])
}

model Charge {
  id String @id @default(uuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  serviceOrderId String?
  serviceOrder   ServiceOrder? @relation(fields: [serviceOrderId], references: [id])

  amountCents Int
  currency    String @default("BRL")

  status  ChargeStatus @default(PENDING)
  dueDate DateTime

  paidAt DateTime?
  notes  String?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, createdAt])
  @@index([orgId, status, dueDate])
  @@index([customerId, createdAt])
  @@index([serviceOrderId, createdAt])
}

model Payment {
  id String @id @default(uuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  chargeId String
  charge   Charge @relation(fields: [chargeId], references: [id])

  amountCents Int
  method      PaymentMethod
  paidAt      DateTime      @default(now())
  notes       String?
  externalRef String?

  createdAt DateTime @default(now())

  @@index([orgId, createdAt])
  @@index([chargeId, createdAt])
  @@index([orgId, paidAt])
}
